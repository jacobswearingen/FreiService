@page "/holydays"
@using FreiService.Data.Services
@using FreiService.Data.Models
@rendermode InteractiveServer
@inject IHolyDaysService HolyDaysService

<PageTitle>Holy Days Manager</PageTitle>

<h1>Holy Days Manager</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Calculate Holy Days</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="yearInput" class="form-label">Year:</label>
                    <input type="number" 
                           class="form-control" 
                           id="yearInput" 
                           @bind="selectedYear" 
                           min="1583" 
                           max="9999" />
                </div>
                <button class="btn btn-primary" @onclick="CalculateYear">
                    <i class="bi bi-calculator"></i> Dry Run - Calculate
                </button>
            </div>
        </div>

        @if (calculatedHolyDays != null && calculatedHolyDays.Count > 0)
        {
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Calculated Holy Days for @selectedYear</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Holy Day</th>
                                <th>Date</th>
                                <th>Day of Week</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var holyDay in calculatedHolyDays.OrderBy(h => h.Value))
                            {
                                <tr>
                                    <td><strong>@holyDay.Key</strong></td>
                                    <td>@holyDay.Value.ToString("MMMM dd, yyyy")</td>
                                    <td>@holyDay.Value.DayOfWeek</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    
                    <div class="mt-3">
                        @if (yearExists)
                        {
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-exclamation-triangle"></i> Holy days for year @selectedYear already exist in the database.
                            </div>
                            <button class="btn btn-warning" @onclick="ConfirmOverwrite">
                                <i class="bi bi-arrow-repeat"></i> Overwrite Existing Data
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-success" @onclick="SaveYear">
                                <i class="bi bi-save"></i> Save to Database
                            </button>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert @messageClass mt-3" role="alert">
                            @message
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Saved Holy Days</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="viewYear" class="form-label">View Year:</label>
                    <div class="input-group">
                        <input type="number" 
                               class="form-control" 
                               id="viewYear" 
                               @bind="viewYear" 
                               min="1583" 
                               max="9999" />
                        <button class="btn btn-outline-secondary" @onclick="LoadYear">
                            <i class="bi bi-search"></i> Load
                        </button>
                    </div>
                </div>

                @if (savedHolyDays != null && savedHolyDays.Count > 0)
                {
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Holy Day</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var holyDay in savedHolyDays)
                            {
                                <tr>
                                    <td>@holyDay.Name</td>
                                    <td>@holyDay.Date.ToString("MMM dd, yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    
                    <button class="btn btn-danger btn-sm mt-2" @onclick="DeleteYear">
                        <i class="bi bi-trash"></i> Delete Year @viewYear
                    </button>
                }
                else if (viewYear > 0)
                {
                    <div class="alert alert-info" role="alert">
                        No holy days found for year @viewYear.
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private int selectedYear = DateTime.Now.Year;
    private int viewYear = DateTime.Now.Year;
    private Dictionary<string, DateTime>? calculatedHolyDays;
    private List<HolyDay>? savedHolyDays;
    private bool yearExists = false;
    private string? message;
    private string messageClass = "alert-info";

    protected override async Task OnInitializedAsync()
    {
        await LoadYear();
    }

    private async Task CalculateYear()
    {
        try
        {
            calculatedHolyDays = HolyDaysService.CalculateHolyDaysForYear(selectedYear);
            yearExists = await HolyDaysService.HolyDaysExistForYearAsync(selectedYear);
            message = null;
        }
        catch (Exception ex)
        {
            message = $"Error calculating holy days: {ex.Message}";
            messageClass = "alert-danger";
        }
    }

    private async Task SaveYear()
    {
        try
        {
            await HolyDaysService.SaveHolyDaysForYearAsync(selectedYear);
            message = $"Successfully saved holy days for year {selectedYear}!";
            messageClass = "alert-success";
            yearExists = true;
            
            // Refresh the saved holy days view if viewing the same year
            if (viewYear == selectedYear)
            {
                await LoadYear();
            }
        }
        catch (Exception ex)
        {
            message = $"Error saving holy days: {ex.Message}";
            messageClass = "alert-danger";
        }
    }

    private async Task ConfirmOverwrite()
    {
        try
        {
            await HolyDaysService.DeleteHolyDaysByYearAsync(selectedYear);
            await HolyDaysService.SaveHolyDaysForYearAsync(selectedYear);
            message = $"Successfully overwritten holy days for year {selectedYear}!";
            messageClass = "alert-success";
            
            // Refresh the saved holy days view if viewing the same year
            if (viewYear == selectedYear)
            {
                await LoadYear();
            }
        }
        catch (Exception ex)
        {
            message = $"Error overwriting holy days: {ex.Message}";
            messageClass = "alert-danger";
        }
    }

    private async Task LoadYear()
    {
        try
        {
            savedHolyDays = await HolyDaysService.GetHolyDaysByYearAsync(viewYear);
        }
        catch (Exception ex)
        {
            message = $"Error loading holy days: {ex.Message}";
            messageClass = "alert-danger";
        }
    }

    private async Task DeleteYear()
    {
        try
        {
            var count = await HolyDaysService.DeleteHolyDaysByYearAsync(viewYear);
            message = $"Deleted {count} holy days for year {viewYear}.";
            messageClass = "alert-warning";
            savedHolyDays = null;
            
            // Update yearExists if we deleted the currently calculated year
            if (viewYear == selectedYear)
            {
                yearExists = false;
            }
        }
        catch (Exception ex)
        {
            message = $"Error deleting holy days: {ex.Message}";
            messageClass = "alert-danger";
        }
    }
}
